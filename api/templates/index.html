{% extends "layout.html" %}

{% block title %}
Portfolio
{% endblock %}

{% block main %}
<style>

    .banner {
        display: flex;
        justify-content: space-around;
        background-color: #f2f2f2;
        /* Background color */
        padding: 10px;
        border-bottom: 2px solid #ddd;
        /* Border style */
    }

    .banner-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: right;
    }

    .label {
        font-weight: bold;
        margin-bottom: 5px;
        color: black;
    }

    .value {}

    .time-navigation .bg-gray-200 {
        background-color: #f0f3f6 !important;
    }

    .time-navigation li.nav-item>a {
        margin-right: 10px;
        color: black !important;
    }

    .time-navigation li.nav-item>a.active:focus,
    .time-navigation li.nav-item>a.active {
        background-color: #46bc5c !important;
        color: #ffffff;
    }
    /* Responsive Styles */
    @media screen and (max-width: 768px) {
        .banner {
            flex-direction: column;
            align-items: center;
        }

        .banner-item {
            width: 100%;
            margin-bottom: 10px;
        }

        /* Adjust font sizes, padding, and margins as needed */
        .label, .value {
            font-size: smaller;
            margin: 5px;
        }
    }
</style>
<div class="banner">
    <div class="banner-item">
        <span class="label">Starting amount:</span>
        <span class="value">$10,000.00</span>
    </div>
    <div class="banner-item">
        <span class="label">Available Funds:</span>
        <span class="value">{{cash}}</span>
    </div>
    <div class="banner-item">
        <span class="label">Total Portfolio Value:</span>
        <span id="portval" class="value">{{total}}</span>
    </div>
    <div class="banner-item">
        <span class="label">Total P&L:</span>
        <span id="tot_pl" class="value">${{pl}}</span>
    </div>
    <div class="banner-item">
        <span class="label">Percentage P&L:</span>
        <span id="perc_pl" class="value">{{percent_pl}}%</span>
    </div>
</div>
<div class="rounded p-4 shad opacity-75">
    <div class="row g-4">
        <div class="col-sm-12 col-xl-8 container-fluid">
            <div class="bg-light text-center rounded p-4 shadow h-100">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <!-- <h6 class="mb-0">Historical Performance of assets in portfolio</h6> -->

                    <div class="box-controls pull-right time-navigation">
                        <ul class="nav nav-pills nav-pills-sm" role="tablist">
                            <li class="nav-item">
                                <a class="nav-link py-2 px-4 b-0 bg-gray-200" data-bs-toggle="tab" data-value="Day"
                                    href="#">
                                    <span class="nav-text base-font">Day</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link py-2 px-4 b-0 bg-gray-200" data-bs-toggle="tab"
                                    data-value="Week" href="#">
                                    <span class="nav-text base-font">Week</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link py-2 px-4 b-0 bg-gray-200 active" data-bs-toggle="tab" data-value="Month"
                                    href="#">
                                    <span class="nav-text base-font">Month</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link py-2 px-4 b-0 bg-gray-200 " data-bs-toggle="tab" data-value="Year"
                                    href="#">
                                    <span class="nav-text base-font">Year</span>
                                </a>
                            </li>

                        </ul>
                    </div>
                    <div>
                        <select name="stock-symbol" id="stock-symbol">

                            {% for stock in portfolio %}
                            <option data-name="{{stock.stock_name}}" value="{{stock.stock_symbol}}">{{stock.stock_name}}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div>

                    <div id="chart_plot" class="w-100 d-flex"></div>

                </div>
            </div>
        </div>
        <div class="col-sm-12 col-xl-4 container-fluid">
            <div class="bg-light text-center text-light rounded p-4 shadow">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h6 class="mb-0">Market Feed</h6>
                    <div>
                        <select class="form-select" aria-label="Default select example">
                            <option selected>Latest</option>
                        </select>
                    </div>
                </div>
                <!-- <canvas id="worldwide-sales"></canvas> -->
                <img id="news1_img">
                <h5 id="news1"></h5>
                <img id="news2_img">
                <h5 id="news2"></h5>
                <img id="news3_img">
                <h5 id="news3"></h5>
                <!-- <img src="static/img/feed.png" alt="Market Feed" class="container-fluid"> -->
            </div>
        </div>

    </div>
</div>

<div class="container-fluid bg-dark text-center rounded p-4 shado opacity-75 table-responsive-sm">
    <h1 style="color:white">My Portfolio</h1>
    <table class="table table-dark table-hover">
        <thead>
            <tr>
                <th class="text-start">Symbol</th>
                <th class="text-start">Name</th>
                <th class="text-start">Asset Type</th>
                <th class="text-end">Number Owned</th>
                <th class="text-end">Current Price (per unit)</th>
                <th class="text-end">TOTAL</th>
            </tr>
        </thead>
        <tbody>
            {% for stock in portfolio %}
            <tr>
                <td class="text-start">{{stock.stock_symbol}}</td>
                <td class="text-start">{{stock.stock_name}}</td>
                <td class="text-start">{{stock.type}}</td>
                <td class="text-end">{{stock.num_shares}}</td>
                <td class="text-end">{{stock.price | usd}}</td>
                <td class="text-end">{{(stock.price * stock.num_shares) | usd}}</td>
            </tr>
            {% endfor %}

        </tbody>
    </table>
    <br><br>
    <div
        class="d-flex justify-content-xl-between container-fluid flex-sm-column flex-xl-row flex-lg-row flex-md-row flex-column">
        <form action="/buy" method="post">
            <div class="mb-3">
                <input autocomplete="off" class="form-control mx-auto w-auto" name="symbol" placeholder="Symbol"
                    type="text">
            </div>
            <div class="mb-3">
                <input class="form-control mx-auto w-auto" name="shares" min="1" placeholder="Number to Buy"
                    type="number">
            </div>
            <div class="mb-3">
                <select name="type" id="assetTypeSelect" onchange="validateSelection_1()">
                    <option selected="true" disabled="disabled">Choose Asset Type</option>
                    {% for type in types %}
                    <option value="{{type}}">{{type}}</option>
                    {% endfor %}
                </select>
            </div>
            <button class="btn btn-primary" type="submit" id="submitButton_1" disabled>Buy</button>
        </form>
        <br>
        <form action="/quote" method="post">
            <div class="mb-3">
                <input autocomplete="off" class="form-control mx-auto w-auto" id="symbol" name="symbol"
                    placeholder="Symbol" type="text">
            </div>
            <div class="mb-3">
                <select name="type" id="assetTypeSelect_2" onchange="validateSelection_2()">
                    <option selected="true" disabled="disabled">Choose Asset Type</option>
                    {% for type in types %}
                    <option value="{{type}}">{{type}}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <button class="btn btn-primary" type="submit" id="submitButton_2" disabled>Get more info about this
                    asset</button>
            </div>
        </form>
        <br>
        <form action="/sell" method="post">
            <div class="mb-3">
                <select name="symbol" id="symbolSelect" onchange="validateSelection()">
                    <option selected="true" disabled="disabled">Choose Symbol</option>
                    {% for stock in portfolio %}
                    <option value="{{stock.stock_symbol}}">{{stock.stock_symbol}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <select name="type" id="assetTypeSelect_1" onchange="validateSelection()">
                    <option selected="true" disabled="disabled">Choose Asset Type</option>
                    {% for type in types %}
                    <option value="{{type}}">{{type}}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <input class="form-control mx-auto w-auto" name="shares" min="1" placeholder="Number To Sell"
                    type="number">
            </div>
            <button class="btn btn-primary" type="submit" id="submitButton" disabled>Sell</button>
        </form>
    </div>
    {% if session["answer"] and session["question"] != "" %}
    <div>
        <h3 class="text-light">Here's your answer!</h3>
    </div>
    <div
        class="d-flex justify-content-xl-center container-fluid flex-sm-column flex-xl-row flex-lg-row flex-md-row flex-column">
        <div>{{session["answer"]}}</div>
    </div>
    <div
        class="d-flex justify-content-xl-center container-fluid flex-sm-column flex-xl-row flex-lg-row flex-md-row flex-column">
        <form action="/learn" method="post">
            <div class="mb-3">
                <input class="form-control mx-auto w-auto" id="symbol" name="symbol" type="hidden" value="">
            </div>
            <br>
            <div>
                <button class="btn btn-primary" type="submit">Ask another question</button>
            </div>
        </form>
        <br>
    </div>
    <br>
    Powered by OpenAI
</div>
{% else %}
<div>
    <h3 class="text-light">NLP Based Search- Ask your finance questions now!</h3>
</div>
<div
    class="d-flex justify-content-xl-center container-fluid flex-sm-column flex-xl-row flex-lg-row flex-md-row flex-column">
    <form action="/learn" method="post">
        <div class="mb-3">
            <input autocomplete="off" class="form-control mx-auto w-auto" id="symbol" name="symbol"
                placeholder="Question" type="text">
        </div>
        <br>
        <div>
            <button class="btn btn-primary" type="submit">Get Answer</button>
        </div>
    </form>
    <br>
</div>
<br>
Powered by OpenAI
</div>
{% endif %}
</div>
</div>
<br>

</div>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    let total = "{{total}}"
    total = parseInt(total.replace(",", "").replace("$", ""))
    let portval = document.getElementById("portval")
    let tot_pl = document.getElementById("tot_pl")
    let perc_pl = document.getElementById("perc_pl")
    if (total >= 10000) {
        portval.style.color = "green";
        tot_pl.style.color = "green";
        perc_pl.style.color = "green";
    } else {
        portval.style.color = "red";
        tot_pl.style.color = "red";
        perc_pl.style.color = "red";
    }
    function validateSelection() {
        var symbolSelect = document.getElementById('symbolSelect');
        var assetSelect = document.getElementById('assetTypeSelect_1');
        var submitButton = document.getElementById('submitButton');
        if (symbolSelect.value != "" && assetSelect.value != "Choose Asset Type") {
            console.log(assetSelect.value)
            submitButton.disabled = false;
        } else {
            submitButton.disabled = true;
        }
    }

    function validateSelection_1() {
        var assetTypeSelect = document.getElementById('assetTypeSelect');
        var submitButton = document.getElementById('submitButton_1');
        if (assetTypeSelect.value != "") {
            submitButton.disabled = false;
        } else {
            submitButton.disabled = true;
        }
    }

    function validateSelection_2() {
        var assetTypeSelect = document.getElementById('assetTypeSelect_2');
        var submitButton = document.getElementById('submitButton_2');
        if (assetTypeSelect.value != "") {
            submitButton.disabled = false;
        } else {
            submitButton.disabled = true;
        }
    }

    url = `https://financialmodelingprep.com/api/v3/quote/{symbol}?apikey=6fbceaefb411ee907e9062098ef0fd66`

    // Get today's date
    const today = new Date();

    // Get yesterday's date
    const endDate = new Date(today);
    endDate.setDate(endDate.getDate());

    // Get the date one month ago
    let startDate = new Date(today);
    let stock_symbol = document.querySelector("#stock-symbol");
    let navLinks = document.querySelectorAll('.nav-link'); // $('.nav-link')

    startDate.setMonth(startDate.getMonth() - 1);
    const tempStartData = startDate.toISOString().split('T')[0];
    const tempEndData = endDate.toISOString().split('T')[0];
    console.log(tempStartData, tempEndData)
    async function fetchStockDataMonth(symbol, formattedStartDate, formattedEndDate) {
        const response = await fetch(`https://financialmodelingprep.com/api/v3/historical-price-full/${symbol}?from=${formattedStartDate}&to=${formattedEndDate}&apikey=6fbceaefb411ee907e9062098ef0fd66`);
        const data = await response.json();
        return data.historical;
    }
    async function fetchStockDataDay(symbol, formattedStartDate, formattedEndDate,time_interval) {
        const response = await fetch(`https://financialmodelingprep.com/api/v3/historical-chart/${time_interval}/${symbol}?from=${formattedStartDate}&to=${formattedEndDate}&apikey=6fbceaefb411ee907e9062098ef0fd66`);
        const data = await response.json();
        return data;
    }

    async function calculateMovingAverage(symbol, formattedStartDate, formattedEndDate,time_interval) {
        const response = await fetch(`https://financialmodelingprep.com/api/v3/technical_indicator/${time_interval}/${symbol}?type=sma&period=10&from=${formattedStartDate}&to=${formattedEndDate}&apikey=6fbceaefb411ee907e9062098ef0fd66`);
        const data = await response.json();
        return data
    }

    async function renderCandlestickChart(data, symbol, selected_name, start, end,time_interval="1day") {
        const trace = {
            x: data.map(item => item.date),
            close: data.map(item => item.close),
            high: data.map(item => item.high),
            low: data.map(item => item.low),
            open: data.map(item => item.open),

            // Customization of the candlestick chart
            increasing: { line: { color: 'green' } },
            decreasing: { line: { color: 'red' } },

            type: 'candlestick',
            name: `${symbol}`
        };

        const vwapDataTrace = {
            x: data.map(item => item.date),
            y: data.map(item => item.vwap),
            type: 'scatter',
            mode: 'lines',
            name: 'vwap'
        }

        // Fetch the SMA data
        const movingAverageData = await calculateMovingAverage(symbol, start, end,time_interval);
        // Create a new trace for the SMA
        const movingAverageTrace = {
            x: movingAverageData.map(item => item.date),
            y: movingAverageData.map(item => item.sma),
            type: 'scatter',
            mode: 'lines',
            name: '10-day SMA'
        };

        const layout = {
            title: `${selected_name} Perfomance`,
            xaxis: {
                type: 'date',
                title: 'Date'
            },
            yaxis: {
                autorange: true,
                title: 'Stock Price'
            },
            noData: {
                text: 'Market is closed.',
                // You can further customize the appearance of the 'no data' message
                font: {
                    size: 16,
                    color: '#888888'
                }
            }
        };
        if (data.length === 0) {
            // Display a custom message or handle the absence of data in your preferred way
            document.getElementById('chart_plot').innerHTML = 'Market is closed';
        }else {
            document.getElementById('chart_plot').innerHTML = '';
            Plotly.newPlot('chart_plot', [trace, movingAverageTrace, vwapDataTrace], layout, { responsive: true });
        }

    }

    const symbol = stock_symbol.value;
    const selectedOption = stock_symbol.options[stock_symbol.selectedIndex];
    const selected_name = selectedOption.getAttribute('data-name');

    fetchStockDataMonth(symbol, tempStartData, tempEndData).then(data => { renderCandlestickChart(data, symbol, selected_name, tempStartData, tempEndData) }).catch(err => console.log(err));
    stock_symbol.onchange = async (el) => {
        const symbol = stock_symbol.value;
        const selectedOption = stock_symbol.options[stock_symbol.selectedIndex];
        const selected_name = selectedOption.getAttribute('data-name');
        navLinks.forEach(function (link) {
            link.classList.remove('active');
        });
        const element = document.querySelector('[data-value="Month"]');
        if (element) {
            element.classList.add('active');
        }
        fetchStockDataMonth(symbol, tempStartData, tempEndData).then(data => { renderCandlestickChart(data, symbol, selected_name, tempStartData, tempEndData) }).catch(err => console.log(err));
    }
    navLinks.forEach(function (link) {
        // Add the async function as the click event handler
        link.addEventListener('click', handleClick);
    });
    async function handleClick() {
        const symbol = stock_symbol.value;
        const selectedOption = stock_symbol.options[stock_symbol.selectedIndex];
        const selected_name = selectedOption.getAttribute('data-name');
        let interval = this.getAttribute('data-value');
        const currentDate = new Date();
        let endDate = new Date(currentDate);
        let startDate;
        switch (interval) {
            case 'Day':
                startDate = new Date(currentDate);
                // startDate.setDate(currentDate.getDate() -1);
                // endDate.setDate(currentDate.getDate() -1);
                break;
            case 'Week':
                startDate = new Date(currentDate);
                startDate.setDate(currentDate.getDate() - currentDate.getDay()); // Start of the week
                break;
            case 'Month':
                startDate = new Date(currentDate);
                startDate.setMonth(startDate.getMonth() - 1);
                break;
            case 'Year':
                startDate = new Date(currentDate);
                startDate.setFullYear(startDate.getFullYear() - 1); // Start of the previous year
                break;
            case '5years':
                startDate = new Date(currentDate);
                startDate.setFullYear(startDate.getFullYear() - 5); // Start of 5 years ago
                break;
            default:
                console.error('Invalid interval specified');
                return;
        }
         // Format the dates as YYYY-MM-DD
        const formattedStartDate = startDate.toISOString().split('T')[0];
        const formattedEndDate = endDate.toISOString().split('T')[0];
        console.log("start date and end date", formattedStartDate, formattedEndDate);
        console.log("symbol, selected_name", symbol, selected_name);
        if(interval=='Day'|| interval=='Week'){
            const time_interval = interval=='Day'?'5min':'15min';
             fetchStockDataDay(symbol, formattedStartDate, formattedEndDate,time_interval).then(data => { renderCandlestickChart(data, symbol, selected_name, formattedStartDate, formattedEndDate,time_interval) }).catch(err => console.log(err));
        }else{
            fetchStockDataMonth(symbol, formattedStartDate, formattedEndDate).then(data => { renderCandlestickChart(data, symbol, selected_name, formattedStartDate, formattedEndDate) }).catch(err => console.log(err));
        }

    }
    function restartAnimation(element) {
        // Remove the class
        element.classList.remove('slide-in');

        // Force a reflow/repaint
        void element.offsetWidth;

        // Re-add the class
        element.classList.add('slide-in');
    }
    function updateNews() {
        fetch(`https://stocknewsapi.com/api/v1/category?section=general&items=3&page=1&token=qvgfptpokzmfkdag1opnwj9c2svtukxyseprol1n`)
            .then(response => response.json())
            .then(result => {
                const news1 = document.querySelector("#news1")
                const news1Image = document.querySelector("#news1_img")
                const news2 = document.querySelector("#news2")
                const news2Image = document.querySelector("#news2_img")
                const news3 = document.querySelector("#news3")
                const news3Image = document.querySelector("#news3_img")
                news1.innerHTML = result.data[0]["title"] + "<div>Date: " + result.data[0]["date"] + "</div>" + "<div style='color:green'>Sentiment: " + result.data[0]["sentiment"] + "</div>" + "<div>\nLink to article:</div> " + "<div><a style='color:blue; font-size:12px' href=" + result.data[0]["news_url"] + ">" + result.data[0]["news_url"] + "</a></div>"
                news1Image.src = result.data[0]["image_url"]
                news1.classList.add('slide-in');
                news1.classList.add('news');
                news1Image.classList.add('slide-in');
                news1Image.classList.add('news');
                news2.innerHTML = result.data[1]["title"] + "<div>Date: " + result.data[1]["date"] + "</div>" + "<div style='color:green'>Sentiment: " + result.data[1]["sentiment"] + "</div>" + "\nLink to article: " + "<br><a style='color:blue; font-size:12px' href=" + result.data[1]["news_url"] + ">" + result.data[1]["news_url"] + "</a>"
                news2Image.src = result.data[1]["image_url"]
                news2.classList.add('slide-in');
                news2.classList.add('news');
                news2Image.classList.add('slide-in');
                news2Image.classList.add('news');
                news3.innerHTML = result.data[2]["title"] + "<div>Date: " + result.data[2]["date"] + "</div>" + "<div style='color:green'>Sentiment: " + result.data[2]["sentiment"] + "</div>" + "\nLink to article: " + "<br><a style='color:blue; font-size:12px' href=" + result.data[2]["news_url"] + ">" + result.data[2]["news_url"] + "</a>"
                news3Image.src = result.data[2]["image_url"]
                news3.classList.add('slide-in');
                news3.classList.add('news');
                news3Image.classList.add('slide-in');
                news3Image.classList.add('news');
            })
            .catch(err => console.log(err))
    };
    document.addEventListener("DOMContentLoaded", () => {

        updateNews();
        setInterval(updateNews, 300000); // Update every 5 minutes
    });

</script>
{% endblock %}